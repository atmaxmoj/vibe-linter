name: Database Migration
description: No loop, 3-way (success/partial-failure/full-rollback), cross-phase fallback

steps:
  # ── Planning ──

  - 1.1 Plan migration strategy

  - 1.2 Migration review:
      type: wait
      next:
        - if: "migration plan approved"
          go: 2.1 Backup database
        - go: 1.1 Plan migration strategy

  # ── Execution ──

  - 2.1 Backup database

  - 2.2 Execute migration

  - 2.3 Verify migration:
      next:
        - if: "migration fully successful"
          go: 3.1 Post-migration validation
        - if: "partial failure, some tables need fixing"
          go: 2.4 Fix partial failure
        - go: 2.5 Full rollback

  - 2.4 Fix partial failure:
      next: 2.3 Verify migration

  - 2.5 Full rollback:
      next: 1.1 Plan migration strategy

  # ── Validation ──

  - 3.1 Post-migration validation

  - Done:
      type: terminate
      reason: Database migration complete
